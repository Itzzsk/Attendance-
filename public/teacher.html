<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Panel</title>
    <link rel="stylesheet" href="tstyle.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts - Poppins -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">


</head>
<body>
    <div class="container">
        <div class="tab-container">
            <button class="tablinks active" onclick="openTab(event, 'MarkAttendance')">Mark Attendance</button>
            <button class="tablinks" onclick="openTab(event, 'ViewAttendance')">View Attendance</button>
        </div>

        <!-- Mark Attendance Section -->
        <div id="MarkAttendance" class="tabcontent">
            <h2>Mark Attendance</h2>
            <label for="date">Date:</label>
            <input type="date" id="date">
            
           <!-- Include Font Awesome CDN -->
<script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>

<div class="relative w-full">
    <label for="subject" class="block text-white font-medium mb-2">Select Subject:</label>
    <div class="relative">
        <select id="subject" class="w-full p-3 bg-gray-900 text-white border border-gray-600 rounded-lg appearance-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500">
            <option value="">-- Select Subject --</option>
            <option value="ML">Machine Learning</option>
            <option value="Software Testing">Software Testing</option>
            <option value="MAD">Mobile App Development</option>
            <option value="ECD">Embedded Computing & Design</option>
        </select>
        <!-- Font Awesome Dropdown Icon -->
    </div>
</div>


            <div id="loading">Loading students...</div>
            <form id="attendance-form">
                <table>
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Name</th>
                            <th>Present</th>
                        </tr>
                    </thead>
                    <tbody id="students-list"></tbody>
                </table>
                <button type="submit">Submit Attendance</button>
            </form>
        </div>

          <!-- View Attendance Tab -->
    <div id="ViewAttendance" class="tabcontent" style="display: none;">
      <div>
        <label for="subjectSelect">Select Subject:</label>
        <select id="subjectSelect">
          <option value="">-- Select Subject --</option>
          <option value="ML">Machine Learning</option>
          <option value="Software Testing">Software Testing</option>
          <option value="MAD">Mobile App Development</option>
          <option value="ECD">Embedded Computing & Design</option>
        </select>
        <button onclick="loadRegister()">Load Register</button>
      </div>
    
      <!-- Display attendance register for the selected subject -->
      <div id="attendanceRegisterContainer" style="margin-top: 20px;"></div>
    
      <!-- Edit Button (Initially hidden) -->
    
      <!-- Save Changes Button (Initially hidden) -->
      <button id="saveChangesBtn" onclick="saveAttendanceChanges()" style="margin-top: 20px; display: none;">Save Changes</button>
    </div>
  </div>

    <script>
        function openTab(evt, tabName) {
            document.querySelectorAll(".tabcontent").forEach(tab => tab.style.display = "none");
            document.querySelectorAll(".tablinks").forEach(tab => tab.classList.remove("active"));
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.classList.add("active");
        }

        document.addEventListener("DOMContentLoaded", function () {
            const studentList = document.getElementById("students-list");
            const loadingMessage = document.getElementById("loading");

            async function fetchStudents() {
                try {
                    const response = await fetch("/teacher/students");
                    const students = await response.json();
            
                    if (!students.length) {
                        loadingMessage.innerHTML = "No students found.";
                        return;
                    }
                    students.sort((a, b) => a.studentID.localeCompare(b.studentID, undefined, { numeric: true }));
            
                    loadingMessage.style.display = "none";
                    studentList.innerHTML = "";
                    students.forEach(student => {
                        studentList.insertAdjacentHTML("beforeend", `
                            <tr>
                                <td>${student.studentID}</td>
                                <td>${student.name}</td>
                                <td><input type="checkbox" name="attendance" value="${student.studentID}" checked></td>
                            </tr>`);
                    });
                } catch (error) {
                    console.error("Error fetching students:", error);
                    loadingMessage.innerHTML = "Error loading students.";
                }
            }
            

            fetchStudents();

            document.getElementById("attendance-form").addEventListener("submit", async function (event) {
                event.preventDefault();

                const date = document.getElementById("date").value;
                const subject = document.getElementById("subject").value;

                if (!date || !subject) {
                    alert("Please select a date and subject.");
                    return;
                }

                const selectedStudents = Array.from(document.querySelectorAll('input[name="attendance"]:checked'))
                    .map(checkbox => checkbox.value);

                const attendanceData = { date, subject, studentsPresent: selectedStudents };

                try {
                    const response = await fetch("/teacher/mark-attendance", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(attendanceData)
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || "Failed to submit attendance.");

                    alert("Attendance submitted successfully!");
                } catch (error) {
                    console.error("Error submitting attendance:", error);
                    alert("Error submitting attendance. Check console for details.");
                }
            });
        });
 async function loadRegister() {
      const subject = document.getElementById('subjectSelect').value;
      const res = await fetch(`/teacher/attendance-register?subject=${encodeURIComponent(subject)}`);
      const data = await res.json();
    
      const { students, attendanceMap } = data;
    
      const dates = Object.keys(attendanceMap).sort(); // sort dates for column headers
      const table = document.createElement('table');
      table.border = '1';
      table.style.borderCollapse = 'collapse';
    
      // Header Row
      const headerRow = document.createElement('tr');
      headerRow.innerHTML = `<th>Student ID</th><th>Name</th>` +
        dates.map(date => `<th>${date}</th>`).join('');
      table.appendChild(headerRow);
    
      // Body Rows
      students.forEach(student => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${student.studentID}</td><td>${student.name}</td>` +
          dates.map(date => {
            const presentIDs = attendanceMap[date].map(id => id.toString());
            return `<td class="attendance-status" data-status="${presentIDs.includes(student._id) ? 'P' : 'A'}" style="text-align:center;">
                      ${presentIDs.includes(student._id) ? 'P' : 'A'}
                    </td>`;
          }).join('');
        table.appendChild(row);
      });
    
      const container = document.getElementById('attendanceRegisterContainer');
      container.innerHTML = '';
      container.appendChild(table);
    
      // After loading, enable the EDIT button
      document.getElementById("editButton").style.display = 'inline-block';
    }
    
    // Function to toggle between view and edit mode
    function toggleEditMode() {
      const statusCells = document.querySelectorAll('.attendance-status');
      const editButton = document.getElementById("editButton");
      const saveButton = document.getElementById("saveChangesBtn");
    
      // Toggle editable status for each attendance cell
      statusCells.forEach(cell => {
        cell.classList.toggle("editable");
        cell.addEventListener("click", toggleStatus);
      });
    
      // Toggle the button text between "EDIT" and "Done"
      if (editButton.textContent === "EDIT") {
        editButton.textContent = "Done"; // After clicking EDIT, show "Done"
      } else {
        editButton.textContent = "EDIT"; // Revert back to EDIT when clicking Done
      }
    
      // Show Save Changes button
      saveButton.style.display = saveButton.style.display === "none" ? "inline-block" : "none";
    }
    
    // Function to toggle attendance status between P and A
    function toggleStatus() {
      const currentStatus = this.dataset.status;
      const newStatus = currentStatus === 'P' ? 'A' : 'P';
      this.textContent = newStatus;
      this.dataset.status = newStatus;
    }
    
    // Function to save changes (you can integrate it with backend)
    function saveAttendanceChanges() {
      const attendanceData = [];
    
      // Collect modified attendance data
      document.querySelectorAll('.attendance-status').forEach(cell => {
        const studentID = cell.parentElement.cells[0].textContent;
        const date = cell.parentElement.cells[2].textContent; // Get the date from table header
        const status = cell.textContent === 'P' ? 'P' : 'A';
        attendanceData.push({ studentID, date, status });
      });
    
      // Send modified attendance data to backend
      fetch("/teacher/save-attendance", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ attendanceData })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert("Attendance updated successfully!");
          document.getElementById("saveChangesBtn").style.display = "none"; // Hide Save Changes button
        } else {
          alert("Error saving changes.");
        }
      })
      .catch(error => {
        console.error("Error saving attendance:", error);
      });
    }
     
    </script>
</body>
</html>
